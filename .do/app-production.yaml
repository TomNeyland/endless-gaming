name: endless-gaming
region: nyc1

# Database-free JSON generation service with internal cron
services:
  - name: json-export-service
    source_dir: /
    github:
      repo: tomneyland/endless-gaming
      branch: master
    environment_slug: python
    
    build_command: |
      cd endless-gaming-backend
      pip install poetry
      poetry config virtualenvs.create false
      poetry install --only=main
      # Download and install GitHub CLI binary directly (no apt required)
      curl -L https://github.com/cli/cli/releases/latest/download/gh_linux_amd64.tar.gz -o gh.tar.gz
      tar -xzf gh.tar.gz
      mv gh_*/bin/gh /app/gh
      chmod +x /app/gh
      rm -rf gh*
      
      # Download and install jq binary directly
      curl -L https://github.com/jqlang/jq/releases/latest/download/jq-linux-amd64 -o /app/jq
      chmod +x /app/jq
    
    run_command: |
      # Navigate to backend directory
      cd endless-gaming-backend
      
      # Create the cron script
      cat > /app/run-export.sh << 'EOF'
      #!/bin/bash
      set -e
      export PYTHONPATH=/app/endless-gaming-backend
      cd /app/endless-gaming-backend
      echo "$(date): Starting JSON export"
      python scripts/generate_master_json_direct.py /tmp/master.json --max-pages 15 --max-games 1000
      
      if [ -n "$GITHUB_TOKEN" ] && [ -n "$GITHUB_REPO" ]; then
        export PATH="/app:$PATH"
        CURRENT_SHA=$(/app/gh api repos/$GITHUB_REPO/contents/master.json --jq '.sha' 2>/dev/null || echo "")
        CONTENT=$(base64 -i /tmp/master.json | tr -d '\n')
        
        if [ -n "$CURRENT_SHA" ]; then
          /app/gh api repos/$GITHUB_REPO/contents/master.json --method PUT --field message="ðŸŽ® Daily update - $(date '+%Y-%m-%d')" --field content="$CONTENT" --field sha="$CURRENT_SHA"
        else
          /app/gh api repos/$GITHUB_REPO/contents/master.json --method PUT --field message="ðŸŽ® Initial data - $(date '+%Y-%m-%d')" --field content="$CONTENT"
        fi
        echo "âœ… Updated repository"
      fi
      echo "$(date): Export completed"
      EOF
      
      chmod +x /app/run-export.sh
      
      # Create a simple scheduler that runs daily at 4 AM UTC
      cat > /app/scheduler.sh << 'EOF'
      #!/bin/bash
      
      echo "JSON export service started - daily runs at 4 AM UTC"
      
      # Run initial export immediately
      /app/run-export.sh
      
      # Simple daily scheduler loop
      while true; do
        # Calculate seconds until next 4 AM UTC
        current_hour=$(date -u +%H)
        current_min=$(date -u +%M)
        current_sec=$(date -u +%S)
        
        # Convert current time to seconds since midnight
        current_seconds=$((current_hour * 3600 + current_min * 60 + current_sec))
        
        # Target time: 4 AM = 4 * 3600 = 14400 seconds
        target_seconds=14400
        
        if [ $current_seconds -lt $target_seconds ]; then
          # Next run is today at 4 AM
          sleep_seconds=$((target_seconds - current_seconds))
        else
          # Next run is tomorrow at 4 AM
          sleep_seconds=$((86400 - current_seconds + target_seconds))
        fi
        
        echo "Next export scheduled in $sleep_seconds seconds ($(date -u -d "+${sleep_seconds} seconds" '+%Y-%m-%d %H:%M:%S UTC'))"
        sleep $sleep_seconds
        
        # Run the export
        /app/run-export.sh
      done
      EOF
      
      chmod +x /app/scheduler.sh
      
      # Start the scheduler
      /app/scheduler.sh
    
    envs:
      - key: PYTHONPATH
        scope: RUN_AND_BUILD_TIME
        value: /app
      - key: GITHUB_TOKEN
        scope: RUN_TIME
        value: ${GITHUB_TOKEN}
      - key: GITHUB_REPO
        scope: RUN_TIME
        value: "tomneyland/endless-gaming"
    
    instance_count: 1
    instance_size_slug: basic-s