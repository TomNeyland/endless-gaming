name: endless-gaming
region: nyc1

# Database-free JSON generation service with internal cron
services:
  - name: json-export-service
    source_dir: /
    github:
      repo: tomneyland/endless-gaming
      branch: master
    environment_slug: python
    
    build_command: |
      cd endless-gaming-backend
      pip install poetry
      poetry config virtualenvs.create false
      poetry install --only=main
      # Install GitHub CLI and cron
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
      apt update
      apt install -y gh cron jq
    
    run_command: |
      # Navigate to backend directory
      cd endless-gaming-backend
      
      # Create the cron script
      cat > /app/run-export.sh << 'EOF'
      #!/bin/bash
      set -e
      export PYTHONPATH=/app/endless-gaming-backend
      cd /app/endless-gaming-backend
      echo "$(date): Starting JSON export"
      python scripts/generate_master_json_direct.py /tmp/master.json --max-pages 15 --max-games 1000
      
      if [ -n "$GITHUB_TOKEN" ] && [ -n "$GITHUB_REPO" ]; then
        CURRENT_SHA=$(gh api repos/$GITHUB_REPO/contents/master.json --jq '.sha' 2>/dev/null || echo "")
        CONTENT=$(base64 -i /tmp/master.json | tr -d '\n')
        
        if [ -n "$CURRENT_SHA" ]; then
          gh api repos/$GITHUB_REPO/contents/master.json --method PUT --field message="ðŸŽ® Daily update - $(date '+%Y-%m-%d')" --field content="$CONTENT" --field sha="$CURRENT_SHA"
        else
          gh api repos/$GITHUB_REPO/contents/master.json --method PUT --field message="ðŸŽ® Initial data - $(date '+%Y-%m-%d')" --field content="$CONTENT"
        fi
        echo "âœ… Updated repository"
      fi
      echo "$(date): Export completed"
      EOF
      
      chmod +x /app/run-export.sh
      
      # Set up cron job
      echo "0 4 * * * /app/run-export.sh >> /tmp/cron.log 2>&1" | crontab -
      
      # Start cron and keep service alive
      cron
      echo "JSON export service started - daily runs at 4 AM UTC"
      
      # Run initial export
      /app/run-export.sh
      
      # Keep service alive by tailing logs
      touch /tmp/cron.log
      tail -f /tmp/cron.log
    
    envs:
      - key: PYTHONPATH
        scope: RUN_AND_BUILD_TIME
        value: /app
      - key: GITHUB_TOKEN
        scope: RUN_TIME
        value: ${GITHUB_TOKEN}
      - key: GITHUB_REPO
        scope: RUN_TIME
        value: "tomneyland/endless-gaming"
    
    instance_count: 1
    instance_size_slug: basic-s