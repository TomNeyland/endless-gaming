<mat-sidenav-container class="voting-drawer-container">
  <!-- Main content (pass-through) -->
  <mat-sidenav-content>
    <ng-content></ng-content>
  </mat-sidenav-content>

  <!-- Voting Drawer -->
  <mat-sidenav 
    #drawer 
    mode="side" 
    position="end" 
    [opened]="isOpen"
    (closedStart)="onDrawerClose()"
    class="voting-drawer">
    
    <!-- Drawer Header -->
    <mat-toolbar class="drawer-header">
      <span class="header-title">
        <mat-icon>tune</mat-icon>
        Game Discovery
      </span>
      <button 
        mat-icon-button 
        (click)="drawer.close()"
        class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </mat-toolbar>

    <!-- Drawer Content with Tabs -->
    <div class="drawer-content">
      <mat-tab-group 
        class="discovery-tabs"
        [selectedIndex]="activeTabIndex()"
        (selectedTabChange)="activeTabIndex.set($event.index)"
        animationDuration="200ms">
        
        <!-- Voting Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>how_to_vote</mat-icon>
            <span class="tab-label">Vote</span>
          </ng-template>
          <div class="tab-content voting-tab-content">
            @if (hasValidPair()) {
              <!-- Progress Info -->
              <div class="progress-section">
                <p class="mat-body-2 progress-text">{{ getVotingProgress() }}</p>
                <p class="mat-caption help-text">Choose your preferred game or skip if unsure</p>
              </div>

              <!-- Game Comparison - Vertical Stack -->
              <div class="comparison-section">
                <!-- Game Option 1 -->
                <div class="game-option">
                  <mat-card class="game-card" appearance="outlined">
                    <div class="game-image-container">
                      <img 
                        [src]="getGameThumbnail(getLeftGame()!)"
                        [alt]="getLeftGame()!.name"
                        class="game-image"
                        (error)="$event.target.src='https://via.placeholder.com/300x169/667eea/ffffff?text=Game'">
                    </div>
                    
                    <mat-card-content>
                      <h3 class="game-title">{{ getLeftGame()!.name }}</h3>
                      <div class="game-meta">
                        <span class="price">{{ getGamePrice(getLeftGame()!) }}</span>
                      </div>
                      <div class="game-tags">
                        @for (tag of leftGameTags(); track tag.tag) {
                          <span class="tag-chip clickable-tag" [class]="'tag-' + tag.type" (click)="onTagClick($event, tag.tag)">
                            @if (tag.type === 'popular') {
                              <mat-icon class="tag-icon">trending_up</mat-icon>
                            } @else {
                              <mat-icon class="tag-icon">auto_awesome</mat-icon>
                            }
                            {{ tag.tag }}
                          </span>
                        }
                      </div>
                    </mat-card-content>
                  </mat-card>
                  
                  <button 
                    mat-raised-button 
                    color="primary"
                    class="vote-button vote-left-btn"
                    [disabled]="isVoting()"
                    (click)="voteLeft()">
                    <mat-icon>thumb_up</mat-icon>
                    I Prefer This
                  </button>
                </div>

                <!-- VS Divider -->
                <div class="vs-divider">
                  <div class="vs-badge">
                    <span class="vs-text">VS</span>
                  </div>
                  <div class="divider-line"></div>
                </div>

                <!-- Game Option 2 -->
                <div class="game-option">
                  <mat-card class="game-card" appearance="outlined">
                    <div class="game-image-container">
                      <img 
                        [src]="getGameThumbnail(getRightGame()!)"
                        [alt]="getRightGame()!.name"
                        class="game-image"
                        (error)="$event.target.src='https://via.placeholder.com/300x169/667eea/ffffff?text=Game'">
                    </div>
                    
                    <mat-card-content>
                      <h3 class="game-title">{{ getRightGame()!.name }}</h3>
                      <div class="game-meta">
                        <span class="price">{{ getGamePrice(getRightGame()!) }}</span>
                      </div>
                      <div class="game-tags">
                        @for (tag of rightGameTags(); track tag.tag) {
                          <span class="tag-chip clickable-tag" [class]="'tag-' + tag.type" (click)="onTagClick($event, tag.tag)">
                            @if (tag.type === 'popular') {
                              <mat-icon class="tag-icon">trending_up</mat-icon>
                            } @else {
                              <mat-icon class="tag-icon">auto_awesome</mat-icon>
                            }
                            {{ tag.tag }}
                          </span>
                        }
                      </div>
                    </mat-card-content>
                  </mat-card>
                  
                  <button 
                    mat-raised-button 
                    color="primary"
                    class="vote-button vote-right-btn"
                    [disabled]="isVoting()"
                    (click)="voteRight()">
                    <mat-icon>thumb_up</mat-icon>
                    I Prefer This
                  </button>
                </div>
              </div>

              <!-- Enhanced Voting Options (Compact) -->
              <div class="voting-options-section">
                <div class="voting-options-grid">
                  <button 
                    mat-flat-button 
                    color="primary"
                    class="vote-option vote-like-both-btn"
                    [disabled]="isVoting()"
                    (click)="likeBoth()">
                    <mat-icon>thumb_up</mat-icon>
                    Like Both
                  </button>
                  
                  <button 
                    mat-stroked-button 
                    class="vote-option vote-skip-btn"
                    [disabled]="isVoting()"
                    (click)="skip()">
                    <mat-icon>skip_next</mat-icon>
                    Skip
                  </button>
                  
                  <button 
                    mat-flat-button 
                    color="warn"
                    class="vote-option vote-dislike-both-btn"
                    [disabled]="isVoting()"
                    (click)="dislikeBoth()">
                    <mat-icon>thumb_down</mat-icon>
                    Dislike Both
                  </button>
                </div>
              </div>

              <!-- Preference Summary -->
              <div class="preferences-section">
                <app-preference-summary class="compact-preferences"></app-preference-summary>
              </div>

              <!-- Subtle Loading State -->
              @if (isVoting()) {
                <div class="subtle-loading">
                  <mat-spinner diameter="20" strokeWidth="3"></mat-spinner>
                </div>
              }

            } @else {
              <!-- No More Pairs State -->
              <div class="no-pairs-section">
                <div class="no-pairs-content">
                  <mat-icon class="success-icon">check_circle</mat-icon>
                  <h3 class="mat-headline-6">Great Progress!</h3>
                  <p class="mat-body-1">Your preferences have been updated. Keep the drawer open to see recommendations change as you continue voting, or close it when you're satisfied.</p>
                  
                  <button 
                    mat-button 
                    color="primary"
                    (click)="drawer.close()"
                    class="done-button">
                    <mat-icon>check</mat-icon>
                    Done for Now
                  </button>
                </div>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Filters Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>filter_list</mat-icon>
            <span class="tab-label">Filters</span>
          </ng-template>
          <div class="tab-content filters-tab-content">
            <!-- Filter Panel -->
            <app-filter-panel 
              [games]="games"
              [steamPlayerData]="steamPlayerData"
              [enableSteamFeatures]="enableSteamFeatures">
            </app-filter-panel>
          </div>
        </mat-tab>

        <!-- Steam Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>videogame_asset</mat-icon>
            <span class="tab-label">Steam</span>
          </ng-template>
          <div class="tab-content steam-tab-content">
            <!-- Steam Input Section -->
            <div class="steam-input-section">
              <app-steam-input
                (steamDataLoaded)="onSteamDataLoaded($event)"
                (steamDataCleared)="onSteamDataCleared()">
              </app-steam-input>
            </div>
            
            <!-- Steam Owned/Unowned Toggles (when data is loaded) -->
            @if (hasSteamData()) {
              <div class="steam-toggles-section">
                <mat-card appearance="outlined" class="owned-toggles-card">
                  <mat-card-content>
                    <h4 class="toggles-title">
                      <mat-icon>visibility</mat-icon>
                      Show Games
                    </h4>
                    <div class="toggles-grid">
                      <div class="toggle-item" [class.uninteracted-hint]="shouldShowSteamToggleHints()">
                        <mat-slide-toggle
                          [checked]="getShowOwnedOnly()"
                          (change)="onShowOwnedOnlyChange($event.checked)"
                          color="accent"
                          class="owned-toggle">
                          <span class="toggle-label">
                            <mat-icon class="toggle-icon owned-icon">check_circle</mat-icon>
                            Owned Games Only
                          </span>
                        </mat-slide-toggle>
                      </div>
                      
                      <div class="toggle-item" [class.uninteracted-hint]="shouldShowSteamToggleHints()">
                        <mat-slide-toggle
                          [checked]="getHideOwnedGames()"
                          (change)="onHideOwnedGamesChange($event.checked)"
                          color="accent"
                          class="unowned-toggle">
                          <span class="toggle-label">
                            <mat-icon class="toggle-icon unowned-icon">add_shopping_cart</mat-icon>
                            Hide Owned Games
                          </span>
                        </mat-slide-toggle>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Steam Data Display (when data is loaded) -->
              <div class="steam-data-section">
                <mat-card appearance="outlined" class="steam-info-card">
                  <mat-card-header>
                    <mat-icon mat-card-avatar class="steam-avatar-icon">auto_awesome</mat-icon>
                    <mat-card-title>Steam Library Loaded</mat-card-title>
                    <mat-card-subtitle>{{ getSteamLibraryStats() }}</mat-card-subtitle>
                  </mat-card-header>
                  
                  <mat-card-content>
                    <div class="steam-stats">
                      <div class="stat-item">
                        <mat-icon class="stat-icon">videogame_asset</mat-icon>
                        <span class="stat-label">Total Games:</span>
                        <span class="stat-value">{{ steamPlayerData?.game_count || 0 }}</span>
                      </div>
                      
                      @if (getRecentlyPlayedCount() > 0) {
                        <div class="stat-item">
                          <mat-icon class="stat-icon">schedule</mat-icon>
                          <span class="stat-label">Recently Played:</span>
                          <span class="stat-value">{{ getRecentlyPlayedCount() }}</span>
                        </div>
                      }
                      
                      @if (getTopPlayedGames().length > 0) {
                        <div class="top-games-section">
                          <h4 class="section-title">
                            <mat-icon>trending_up</mat-icon>
                            Most Played Games
                          </h4>
                          <div class="top-games-list">
                            @for (game of getTopPlayedGames(); track game.name) {
                              <div class="top-game-item">
                                <span class="game-name">{{ game.name }}</span>
                                <span class="game-playtime">{{ game.playtime }}</span>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </mat-card-content>
                  
                  <mat-card-actions>
                    <button 
                      mat-button 
                      color="primary"
                      (click)="refreshSteamData()">
                      <mat-icon>refresh</mat-icon>
                      Refresh Library
                    </button>
                    <button 
                      mat-button 
                      color="warn"
                      (click)="clearSteamData()">
                      <mat-icon>clear</mat-icon>
                      Clear Data
                    </button>
                  </mat-card-actions>
                </mat-card>
              </div>
            }
            
            <!-- Steam Help Section -->
            <div class="steam-help-section">
              <mat-card appearance="outlined" class="help-card">
                <mat-card-content>
                  <h4 class="help-title">
                    <mat-icon>help_outline</mat-icon>
                    How Steam Integration Works
                  </h4>
                  <ul class="help-list">
                    <li>Enter your Steam ID or profile URL above</li>
                    <li>We analyze your library and playtime patterns</li>
                    <li>Recommendations are enhanced based on games you love</li>
                    <li>Games you own get special badges and insights</li>
                    <li>Use filters to show only owned/unowned games</li>
                  </ul>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </mat-tab>

      </mat-tab-group>
    </div>
  </mat-sidenav>
</mat-sidenav-container>